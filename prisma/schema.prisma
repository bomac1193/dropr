// Subtaste Prisma Schema
// Multi-layer taste profile system with constellation mapping

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// =============================================================================
// User & Identity
// =============================================================================

model User {
  id          String   @id @default(cuid())
  email       String?  @unique
  displayName String?
  avatarUrl   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  psychometricProfile  PsychometricProfile?
  aestheticPreference  AestheticPreference?
  constellationProfile ConstellationProfile?
  subcultureFits       UserSubcultureFit[]
  contentInteractions  UserContentInteraction[]
  contentScores        ContentScore[]
  embedding            UserEmbedding?

  @@index([email])
}

// =============================================================================
// Psychometric Layer
// =============================================================================

/// PsychometricProfile: Big Five traits + extended taste-relevant traits + Enneagram.
/// All values normalized 0-1.
model PsychometricProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Big Five (OCEAN)
  openness          Float @default(0.5)
  conscientiousness Float @default(0.5)
  extraversion      Float @default(0.5)
  agreeableness     Float @default(0.5)
  neuroticism       Float @default(0.5)

  // Extended traits
  noveltySeeking       Float @default(0.5)
  aestheticSensitivity Float @default(0.5)
  riskTolerance        Float @default(0.5)

  // Confidence scores for each trait
  traitConfidence Json? // { [traitId]: 0-1 confidence }

  // Enneagram (optional)
  enneagramPrimary    Int?    // 1-9
  enneagramWing       Int?    // Adjacent type (e.g., 4w5)
  enneagramTritype    Int[]   @default([]) // [heart, head, gut]
  enneagramTypeScores Json?   // { "1": 0.7, "2": 0.3, ... }
  enneagramConfidence Float   @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// =============================================================================
// Aesthetic Layer
// =============================================================================

/// AestheticPreference: Visual and music preferences bridging psychometrics to content.
model AestheticPreference {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Visual preferences
  colorPaletteVector   Float[] @default([])
  darknessPreference   Float   @default(0.5) // 0 = bright, 1 = dark
  complexityPreference Float   @default(0.5) // 0 = minimal, 1 = complex
  symmetryPreference   Float   @default(0.5) // 0 = asymmetric, 1 = symmetric
  organicVsSynthetic   Float   @default(0.5) // 0 = organic, 1 = synthetic
  minimalVsMaximal     Float   @default(0.5) // 0 = minimal, 1 = maximal

  // Music preferences
  tempoRangeMin               Float @default(80)  // BPM lower bound
  tempoRangeMax               Float @default(140) // BPM upper bound
  energyRangeMin              Float @default(0.3)
  energyRangeMax              Float @default(0.7)
  harmonicDissonanceTolerance Float @default(0.3) // 0 = consonant, 1 = dissonant
  rhythmPreference            Float @default(0.5) // 0 = ambient, 1 = percussive
  acousticVsDigital           Float @default(0.5) // 0 = acoustic, 1 = digital

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// =============================================================================
// Constellation Layer
// =============================================================================

/// ConstellationProfile: User's archetypal taste cluster mapping.
model ConstellationProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Legacy constellation system (27 constellations)
  primaryConstellationId String // ConstellationId (validated at app level)
  blendWeights           Json   // { [ConstellationId]: number }

  // New archetype system (8 viral archetypes)
  primaryArchetypeId     String? // ArchetypeId: vespyr, ignyx, auryn, prismae, solara, crypta, vertex, fluxus
  archetypeBlendWeights  Json?   // { [ArchetypeId]: number }
  migratedToArchetypes   Boolean @default(false)
  migrationDate          DateTime?

  // Derived scores
  subtasteIndex     Float @default(50) // 0-100, taste coherence
  explorerScore     Float @default(50) // 0-100, novelty seeking behavior
  earlyAdopterScore Float @default(50) // 0-100, trend adoption speed

  // Identity
  identityStatement String? // Generated narrative
  shareableHandle   String? // e.g., @vespyr.sage

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([primaryConstellationId])
  @@index([primaryArchetypeId])
}

// =============================================================================
// Subculture Clusters
// =============================================================================

/// SubcultureCluster: Emergent or defined subculture for trend detection.
model SubcultureCluster {
  id               String   @id @default(cuid())
  name             String   @unique
  tags             String[]
  embeddingVector  Float[]  @default([])
  constellationHints String[] @default([]) // ConstellationIds with high affinity

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  userFits UserSubcultureFit[]
  content  ContentItem[]

  @@index([name])
}

/// UserSubcultureFit: Tracks user-subculture relationship over time.
model UserSubcultureFit {
  id           String @id @default(cuid())
  userId       String
  subcultureId String

  user       User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  subculture SubcultureCluster @relation(fields: [subcultureId], references: [id], onDelete: Cascade)

  affinityScore     Float  @default(50) // 0-100
  earlyAdopterScore Float  @default(50) // 0-100
  adoptionStage     String @default("mid") // "early" | "mid" | "late"

  firstSeenAt DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, subcultureId])
  @@index([userId])
  @@index([subcultureId])
}

// =============================================================================
// Content & Interactions
// =============================================================================

/// ContentItem: Any scoreable content piece (image, track, ai_artifact).
model ContentItem {
  id           String  @id @default(cuid())
  type         String  // "image" | "track" | "ai_artifact"
  title        String?
  description  String?
  thumbnailUrl String?
  contentUrl   String?

  featureEmbedding Float[] @default([])
  tags             String[]

  subcultureId String?
  subculture   SubcultureCluster? @relation(fields: [subcultureId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  interactions UserContentInteraction[]
  scores       ContentScore[]
  embedding    ContentEmbedding?

  @@index([type])
  @@index([subcultureId])
}

/// UserContentInteraction: Logs every user-content touchpoint.
model UserContentInteraction {
  id        String @id @default(cuid())
  userId    String
  contentId String

  user    User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  content ContentItem @relation(fields: [contentId], references: [id], onDelete: Cascade)

  interactionType String  // "view" | "like" | "dislike" | "save" | "share" | "skip"
  rating          Int?    // 1-5 star rating
  dwellTimeMs     Int?    // time spent viewing
  source          String  // "quiz" | "swipe" | "feed"

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([contentId])
  @@index([userId, contentId])
  @@index([interactionType])
}

/// ContentScore: Computed alignment between user and content.
model ContentScore {
  id        String @id @default(cuid())
  userId    String
  contentId String

  user    User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  content ContentItem @relation(fields: [contentId], references: [id], onDelete: Cascade)

  // Component scores (0-100)
  psychAlignmentScore    Float @default(0)
  aestheticAlignmentScore Float @default(0)
  behavioralScore        Float @default(0)
  subcultureFitScore     Float @default(0)

  // Combined
  overallScore Float @default(0) // 0-100

  // User-facing
  stars             Int     @default(3) // 1-5
  highlight         Boolean @default(false)
  deleteRecommended Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, contentId])
  @@index([userId])
  @@index([contentId])
  @@index([overallScore])
}

// =============================================================================
// ML Embeddings
// =============================================================================

/// UserEmbedding: Cached taste embeddings for ML operations.
model UserEmbedding {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Embeddings from different sources
  psychometricEmbedding Float[] @default([]) // 64-dim from psychometrics
  visualEmbedding       Float[] @default([]) // 512-dim from CLIP
  audioEmbedding        Float[] @default([]) // 768-dim from Wav2Vec
  compositeEmbedding    Float[] @default([]) // 128-dim unified taste

  // Metadata
  embeddingVersion Int      @default(1)
  lastComputedAt   DateTime @default(now())
  inputHash        String?  // Hash of inputs for cache invalidation

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([embeddingVersion])
}

/// ContentEmbedding: Cached embeddings for content items.
model ContentEmbedding {
  id        String      @id @default(cuid())
  contentId String      @unique
  content   ContentItem @relation(fields: [contentId], references: [id], onDelete: Cascade)

  embedding        Float[] @default([])
  embeddingModel   String  @default("clip-vit-base-patch32")
  embeddingVersion Int     @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([embeddingVersion])
}

// =============================================================================
// Quiz Sessions
// =============================================================================

/// QuizSession: Tracks quiz progress and answers.
model QuizSession {
  id     String  @id @default(cuid())
  userId String?

  status               String   @default("in_progress") // "in_progress" | "completed" | "abandoned"
  selectedQuestions    Json     @default("[]") // Array of question IDs
  answers              Json     @default("[]") // Array of { questionId, answer, timestamp }
  currentQuestionIndex Int      @default(0)
  totalQuestions       Int      @default(0)

  // Results (populated on completion)
  scoringResult Json? // Full ScoringResult object

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

// =============================================================================
// Profile History
// =============================================================================

/// ProfileHistory: Version tracking for user profiles.
model ProfileHistory {
  id          String @id @default(cuid())
  userId      String
  profileType String // "psychometric" | "aesthetic" | "constellation" | "archetype"

  profileData Json   // Snapshot of profile at this point
  version     Int    @default(1)
  trigger     String @default("quiz_complete") // What caused this snapshot

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([userId, profileType])
}
